name: Build and deploy release

on:
  push:
    branches: ["staging"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout project
        uses: actions/checkout@v3
      - name: Set up NodeJS
        uses: actions/setup-node@v2
        with:
          node-version: "19"
      - name: Install TypeScript
        run: npm install -g typescript
      - name: Mark compile.sh as executable
        run: chmod +x compile.sh
      - name: Run compile.sh
        run: ./compile.sh
      - name: Create zip of build
        run: zip -r portal.zip build/*
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: COMMIT_HASH=$(git rev-parse --short "$GITHUB_SHA") && gh release create "$COMMIT_HASH" --repo="$GITHUB_REPOSITORY" --title="${GITHUB_REPOSITORY#*/} Beta ${COMMIT_HASH}" \./portal.zip --generate-notes --latest --prerelease
